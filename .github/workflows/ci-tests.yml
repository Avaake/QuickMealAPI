name: CI - Test

on:
  push:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker & Docker Compose
        run: |
          # Оновлення репозиторіїв та системи
          sudo apt-get update
          sudo apt-get upgrade -y

          # Видалення старих версій Docker, якщо вони є
          sudo apt-get remove -y docker docker-engine docker.io containerd runc

          # Встановлення необхідних інструментів для Docker
          sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common

          # Додавання офіційного репозиторію Docker
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
          sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

          # Оновлення репозиторіїв
          sudo apt-get update

          # Встановлення Docker та Docker Compose
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io
          sudo apt-get install -y docker-compose

      - name: Start service
        run: |
          docker-compose -f docker-compose.test.yml --env-file src/.test.env up --build -d --remove-orphans
          sleep 10

      - name: Run test
        run: |
          docker-compose -f docker-compose.test.yml --env-file src/.test.env exec -T fastapi_test_app sh -c "PYTHONPATH=/app/src pytest -s -vvv"
      - name: Stop service
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down
